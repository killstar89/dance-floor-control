<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dance Floor Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
    }
    #grid {
      display: grid;
      width: 100vw;
      height: 100vh;
    }
    .box {
      width: 100%;
      height: 100%;
      transition: background-color 0.5s;
    }
  </style>
</head>
<body>
  <div id="grid"></div>

  <!-- Firebase via CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAVC55ieVzrvkGYJArkWXeXAJ8KhdbQF2o",
      authDomain: "dancefloorcontrol-473de.firebaseapp.com",
      databaseURL: "https://dancefloorcontrol-473de-default-rtdb.firebaseio.com",
      projectId: "dancefloorcontrol-473de",
      storageBucket: "dancefloorcontrol-473de.appspot.com",
      messagingSenderId: "340793387071",
      appId: "1:340793387071:web:ab3fd040eda7a8cd3d708a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const grid = document.getElementById('grid');
    let cols = 10, rows = 10;

    function createGrid() {
      grid.innerHTML = '';
      cols = Math.floor(window.innerWidth / 50);
      rows = Math.floor(window.innerHeight / 50);
      grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

      for (let i = 0; i < cols * rows; i++) {
        const box = document.createElement('div');
        box.className = 'box';
        grid.appendChild(box);
      }
    }

    function applyPattern(pattern, color) {
      const boxes = document.querySelectorAll('.box');
      boxes.forEach((box, index) => {
        let delay = 0;
        switch (pattern) {
          case 'spiral':
            delay = index * 10;
            break;
          case 'grid':
            delay = (index % cols + Math.floor(index / cols)) * 30;
            break;
          case 'rain':
            delay = Math.random() * 1000;
            break;
          case 'rings':
            const x = index % cols - cols / 2;
            const y = Math.floor(index / cols) - rows / 2;
            delay = Math.sqrt(x*x + y*y) * 40;
            break;
          case 'random':
            delay = Math.random() * 1000;
            break;
          default:
            delay = 0;
        }
        setTimeout(() => {
          box.style.backgroundColor = color;
        }, delay);
      });
    }

    function clearGrid() {
      document.querySelectorAll('.box').forEach(box => {
        box.style.backgroundColor = 'black';
      });
    }

    function updateDisplay(data) {
      if (!data || data.power === 'off') {
        clearGrid();
        return;
      }
      applyPattern(data.pattern || 'grid', data.color || '#0000ff');
    }

    window.addEventListener('resize', () => {
      createGrid();
      // Reapply pattern if settings exist
      db.ref('dancefloor/settings').once('value', snap => {
        updateDisplay(snap.val());
      });
    });

    createGrid();

    // Listen for changes in Firebase
    db.ref('dancefloor/settings').on('value', snapshot => {
      const data = snapshot.val();
      console.log('Firebase update:', data);
      updateDisplay(data);
    });
  </script>
</body>
</html>
